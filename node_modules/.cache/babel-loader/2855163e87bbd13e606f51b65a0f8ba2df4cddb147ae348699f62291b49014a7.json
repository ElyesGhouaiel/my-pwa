{"ast":null,"code":"\"use strict\";\n\n/**\r\n * Copyright 2022 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *      http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.detectGCPResidency = exports.isGoogleComputeEngine = exports.isGoogleComputeEngineMACAddress = exports.isGoogleComputeEngineLinux = exports.isGoogleCloudServerless = exports.GCE_LINUX_BIOS_PATHS = void 0;\nconst fs_1 = require(\"fs\");\nconst os_1 = require(\"os\");\n/**\r\n * Known paths unique to Google Compute Engine Linux instances\r\n */\nexports.GCE_LINUX_BIOS_PATHS = {\n  BIOS_DATE: '/sys/class/dmi/id/bios_date',\n  BIOS_VENDOR: '/sys/class/dmi/id/bios_vendor'\n};\nconst GCE_MAC_ADDRESS_REGEX = /^42:01/;\n/**\r\n * Determines if the process is running on a Google Cloud Serverless environment (Cloud Run or Cloud Functions instance).\r\n *\r\n * Uses the:\r\n * - {@link https://cloud.google.com/run/docs/container-contract#env-vars Cloud Run environment variables}.\r\n * - {@link https://cloud.google.com/functions/docs/env-var Cloud Functions environment variables}.\r\n *\r\n * @returns {boolean} `true` if the process is running on GCP serverless, `false` otherwise.\r\n */\nfunction isGoogleCloudServerless() {\n  /**\r\n   * `CLOUD_RUN_JOB` is used for Cloud Run Jobs\r\n   * - See {@link https://cloud.google.com/run/docs/container-contract#env-vars Cloud Run environment variables}.\r\n   *\r\n   * `FUNCTION_NAME` is used in older Cloud Functions environments:\r\n   * - See {@link https://cloud.google.com/functions/docs/env-var Python 3.7 and Go 1.11}.\r\n   *\r\n   * `K_SERVICE` is used in Cloud Run and newer Cloud Functions environments:\r\n   * - See {@link https://cloud.google.com/run/docs/container-contract#env-vars Cloud Run environment variables}.\r\n   * - See {@link https://cloud.google.com/functions/docs/env-var Cloud Functions newer runtimes}.\r\n   */\n  const isGFEnvironment = process.env.CLOUD_RUN_JOB || process.env.FUNCTION_NAME || process.env.K_SERVICE;\n  return !!isGFEnvironment;\n}\nexports.isGoogleCloudServerless = isGoogleCloudServerless;\n/**\r\n * Determines if the process is running on a Linux Google Compute Engine instance.\r\n *\r\n * @returns {boolean} `true` if the process is running on Linux GCE, `false` otherwise.\r\n */\nfunction isGoogleComputeEngineLinux() {\n  if ((0, os_1.platform)() !== 'linux') return false;\n  try {\n    // ensure this file exist\n    (0, fs_1.statSync)(exports.GCE_LINUX_BIOS_PATHS.BIOS_DATE);\n    // ensure this file exist and matches\n    const biosVendor = (0, fs_1.readFileSync)(exports.GCE_LINUX_BIOS_PATHS.BIOS_VENDOR, 'utf8');\n    return /Google/.test(biosVendor);\n  } catch (_a) {\n    return false;\n  }\n}\nexports.isGoogleComputeEngineLinux = isGoogleComputeEngineLinux;\n/**\r\n * Determines if the process is running on a Google Compute Engine instance with a known\r\n * MAC address.\r\n *\r\n * @returns {boolean} `true` if the process is running on GCE (as determined by MAC address), `false` otherwise.\r\n */\nfunction isGoogleComputeEngineMACAddress() {\n  const interfaces = (0, os_1.networkInterfaces)();\n  for (const item of Object.values(interfaces)) {\n    if (!item) continue;\n    for (const {\n      mac\n    } of item) {\n      if (GCE_MAC_ADDRESS_REGEX.test(mac)) {\n        return true;\n      }\n    }\n  }\n  return false;\n}\nexports.isGoogleComputeEngineMACAddress = isGoogleComputeEngineMACAddress;\n/**\r\n * Determines if the process is running on a Google Compute Engine instance.\r\n *\r\n * @returns {boolean} `true` if the process is running on GCE, `false` otherwise.\r\n */\nfunction isGoogleComputeEngine() {\n  return isGoogleComputeEngineLinux() || isGoogleComputeEngineMACAddress();\n}\nexports.isGoogleComputeEngine = isGoogleComputeEngine;\n/**\r\n * Determines if the process is running on Google Cloud Platform.\r\n *\r\n * @returns {boolean} `true` if the process is running on GCP, `false` otherwise.\r\n */\nfunction detectGCPResidency() {\n  return isGoogleCloudServerless() || isGoogleComputeEngine();\n}\nexports.detectGCPResidency = detectGCPResidency;","map":{"version":3,"names":["fs_1","require","os_1","exports","GCE_LINUX_BIOS_PATHS","BIOS_DATE","BIOS_VENDOR","GCE_MAC_ADDRESS_REGEX","isGoogleCloudServerless","isGFEnvironment","process","env","CLOUD_RUN_JOB","FUNCTION_NAME","K_SERVICE","isGoogleComputeEngineLinux","platform","statSync","biosVendor","readFileSync","test","_a","isGoogleComputeEngineMACAddress","interfaces","networkInterfaces","item","Object","values","mac","isGoogleComputeEngine","detectGCPResidency"],"sources":["../../src/gcp-residency.ts"],"sourcesContent":[null],"mappings":";;AAAA;;;;;;;;;;;;;;;;;;;AAgBA,MAAAA,IAAA,GAAAC,OAAA;AACA,MAAAC,IAAA,GAAAD,OAAA;AAEA;;;AAGaE,OAAA,CAAAC,oBAAoB,GAAG;EAClCC,SAAS,EAAE,6BAA6B;EACxCC,WAAW,EAAE;CACd;AAED,MAAMC,qBAAqB,GAAG,QAAQ;AAEtC;;;;;;;;;AASA,SAAgBC,uBAAuBA,CAAA;EACrC;;;;;;;;;;;EAWA,MAAMC,eAAe,GACnBC,OAAO,CAACC,GAAG,CAACC,aAAa,IACzBF,OAAO,CAACC,GAAG,CAACE,aAAa,IACzBH,OAAO,CAACC,GAAG,CAACG,SAAS;EAEvB,OAAO,CAAC,CAACL,eAAe;AAC1B;AAlBAN,OAAA,CAAAK,uBAAA,GAAAA,uBAAA;AAoBA;;;;;AAKA,SAAgBO,0BAA0BA,CAAA;EACxC,IAAI,IAAAb,IAAA,CAAAc,QAAQ,GAAE,KAAK,OAAO,EAAE,OAAO,KAAK;EAExC,IAAI;IACF;IACA,IAAAhB,IAAA,CAAAiB,QAAQ,EAACd,OAAA,CAAAC,oBAAoB,CAACC,SAAS,CAAC;IAExC;IACA,MAAMa,UAAU,GAAG,IAAAlB,IAAA,CAAAmB,YAAY,EAAChB,OAAA,CAAAC,oBAAoB,CAACE,WAAW,EAAE,MAAM,CAAC;IAEzE,OAAO,QAAQ,CAACc,IAAI,CAACF,UAAU,CAAC;GACjC,CAAC,OAAAG,EAAA,EAAM;IACN,OAAO,KAAK;;AAEhB;AAdAlB,OAAA,CAAAY,0BAAA,GAAAA,0BAAA;AAgBA;;;;;;AAMA,SAAgBO,+BAA+BA,CAAA;EAC7C,MAAMC,UAAU,GAAG,IAAArB,IAAA,CAAAsB,iBAAiB,GAAE;EAEtC,KAAK,MAAMC,IAAI,IAAIC,MAAM,CAACC,MAAM,CAACJ,UAAU,CAAC,EAAE;IAC5C,IAAI,CAACE,IAAI,EAAE;IAEX,KAAK,MAAM;MAACG;IAAG,CAAC,IAAIH,IAAI,EAAE;MACxB,IAAIlB,qBAAqB,CAACa,IAAI,CAACQ,GAAG,CAAC,EAAE;QACnC,OAAO,IAAI;;;;EAKjB,OAAO,KAAK;AACd;AAdAzB,OAAA,CAAAmB,+BAAA,GAAAA,+BAAA;AAgBA;;;;;AAKA,SAAgBO,qBAAqBA,CAAA;EACnC,OAAOd,0BAA0B,EAAE,IAAIO,+BAA+B,EAAE;AAC1E;AAFAnB,OAAA,CAAA0B,qBAAA,GAAAA,qBAAA;AAIA;;;;;AAKA,SAAgBC,kBAAkBA,CAAA;EAChC,OAAOtB,uBAAuB,EAAE,IAAIqB,qBAAqB,EAAE;AAC7D;AAFA1B,OAAA,CAAA2B,kBAAA,GAAAA,kBAAA","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}